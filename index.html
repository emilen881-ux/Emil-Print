<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Эмиль Бирки — чистый TSPL</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body{
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
      background:#e5e7eb;
      margin:0;
    }
    .app{max-width:480px;margin:0 auto;padding:12px;}
    h1{font-size:20px;margin:0 0 8px;}
    .preview-wrap{
      background:#f3f4f6;
      border-radius:12px;
      padding:16px;
      margin-bottom:12px;
      display:flex;
      justify-content:center;
    }
    .label{
      width:40mm;
      height:30mm;
      border:2px solid #111827;
      background:white;
      display:flex;
      flex-direction:column;
      justify-content:center;
      text-align:center;
      padding:1mm 2mm;
      box-sizing:border-box;
      font-size:10pt;
      line-height:1.2;
    }
    .controls input[type="text"]{
      width:100%;
      padding:8px 10px;
      margin-bottom:6px;
      border-radius:8px;
      border:1px solid #d1d5db;
      font-size:14px;
      box-sizing:border-box;
    }
    .btn{
      width:100%;
      padding:10px 14px;
      border-radius:8px;
      border:none;
      font-weight:600;
      font-size:14px;
      cursor:pointer;
      margin-bottom:6px;
      color:white;
    }
    .btn-primary{background:#6366f1;}
    .btn-usb{background:#ec4899;}
    .btn-danger{background:#ef4444;}
    .btn:disabled{opacity:.5;cursor:not-allowed;}
    .row{display:flex;gap:6px;margin-bottom:6px;}
    .row .btn{flex:1;margin-bottom:0;}
    .status{
      font-size:13px;
      margin-bottom:8px;
    }
    #printArea{display:none;}
    @media print{
      @page{size:40mm 30mm;margin:0;}
      body>*:not(#printArea){display:none!important;}
      #printArea{display:block!important;}
      .print-label{
        width:40mm;
        height:30mm;
        border:2px solid #000;
        box-sizing:border-box;
        padding:0 2mm;
        display:flex;
        flex-direction:column;
        justify-content:center;
        text-align:center;
        font-size:10pt;
        line-height:1.2;
      }
    }
  </style>
</head>
<body>
<div class="app">
  <h1>Эмиль Бирки — TSPL</h1>

  <div class="preview-wrap">
    <div class="label" id="preview">
      <div class="l1"></div>
      <div class="l2"></div>
      <div class="l3"></div>
      <div class="l4"></div>
      <div class="l5"></div>
    </div>
  </div>

  <div class="controls">
    <input id="l1" type="text" placeholder="Line 1 (Latin only)">
    <input id="l2" type="text" placeholder="Line 2">
    <input id="l3" type="text" placeholder="Line 3">
    <input id="l4" type="text" placeholder="Line 4">
    <input id="l5" type="text" placeholder="Line 5">
  </div>

  <div class="status" id="usbStatus">USB: not connected</div>

  <button class="btn btn-usb" id="usbConnectBtn">Connect USB printer</button>
  <button class="btn btn-usb" id="usbPrintBtn" disabled>Print via USB (TSPL text)</button>

  <div class="row">
    <button class="btn btn-primary" id="pdfBtn">PDF 40×30</button>
    <button class="btn btn-primary" id="pngBtn">PNG</button>
  </div>

  <button class="btn btn-danger" id="printBtn">Browser print</button>

  <div id="printArea"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
let usbDevice=null;
let usbEndpoint=1;

function updatePreview(){
  const p=document.getElementById('preview');
  const lines=p.querySelectorAll('div');
  for(let i=1;i<=5;i++){
    lines[i-1].textContent=document.getElementById('l'+i).value;
  }
}
['l1','l2','l3','l4','l5'].forEach(id=>{
  document.getElementById(id).addEventListener('input',updatePreview);
});
updatePreview();

// --- TSPL текстовая команда ---
// ВАЖНО: пока только латиница/цифры, без русских
function buildTSPL(){
  const l1=document.getElementById('l1').value;
  const l2=document.getElementById('l2').value;
  const l3=document.getElementById('l3').value;
  const l4=document.getElementById('l4').value;
  const l5=document.getElementById('l5').value;

  let y=20;          // координаты в точках
  const xLeft=20;    // слева небольшой отступ

  let cmd='';
  cmd+='SIZE 40 mm,30 mm\r\n';
  cmd+='GAP 2 mm,0 mm\r\n';
  cmd+='DIRECTION 1\r\n';     // повернуть, если этикетка идёт поперёк
  cmd+='REFERENCE 0,0\r\n';
  cmd+='CLS\r\n';

  if(l1){
    // крупнее для первой строки
    cmd+=`TEXT ${xLeft},${y},"4",0,1,1,"${l1}"\r\n`;
    y+=40;
  }
  if(l2){
    cmd+=`TEXT ${xLeft},${y},"3",0,1,1,"${l2}"\r\n`;
    y+=28;
  }
  if(l3){
    cmd+=`TEXT ${xLeft},${y},"3",0,1,1,"${l3}"\r\n`;
    y+=28;
  }
  if(l4){
    cmd+=`TEXT ${xLeft},${y},"3",0,1,1,"${l4}"\r\n`;
    y+=28;
  }
  if(l5){
    cmd+=`TEXT ${xLeft},${y},"3",0,1,1,"${l5}"\r\n`;
  }

  cmd+='PRINT 1,1\r\n';
  return cmd;
}

// --- USB connect ---
async function connectUSB(){
  if(!navigator.usb){
    alert('WebUSB only in Chrome/Edge');
    return;
  }
  try{
    usbDevice=await navigator.usb.requestDevice({
      filters:[{classCode:7}]
    });
    await usbDevice.open();
    if(usbDevice.configuration===null){
      await usbDevice.selectConfiguration(1);
    }
    const iface=usbDevice.configuration.interfaces[0];
    await usbDevice.claimInterface(iface.interfaceNumber);
    const outEp=iface.alternate.endpoints.find(e=>e.direction==='out');
    if(outEp) usbEndpoint=outEp.endpointNumber;
    document.getElementById('usbStatus').textContent='USB: connected '+(usbDevice.productName||'');
    document.getElementById('usbPrintBtn').disabled=false;
  }catch(e){
    console.error(e);
    alert('USB error: '+e.message);
  }
}

async function printUSB(){
  if(!usbDevice) return;
  const cmd=buildTSPL();
  // строго ASCII, без UTF‑8
  const bytes=new Uint8Array(cmd.length);
  for(let i=0;i<cmd.length;i++){
    bytes[i]=cmd.charCodeAt(i)&0xFF;
  }
  try{
    await usbDevice.transferOut(usbEndpoint,bytes);
  }catch(e){
    console.error(e);
    alert('Print error: '+e.message);
  }
}

// --- PDF 40×30 landscape ---
async function exportPDF(){
  const {jsPDF}=window.jspdf;
  const pdf=new jsPDF({
    orientation:'landscape',
    unit:'mm',
    format:[40,30]
  });
  const canvas=await html2canvas(document.getElementById('preview'),{
    scale:2,
    backgroundColor:'#ffffff'
  });
  const img=canvas.toDataURL('image/png');
  pdf.addImage(img,'PNG',0,0,40,30);
  pdf.save('birka.pdf');
}

// --- PNG ---
async function exportPNG(){
  const canvas=await html2canvas(document.getElementById('preview'),{
    scale:2,
    backgroundColor:'#ffffff'
  });
  const a=document.createElement('a');
  a.href=canvas.toDataURL('image/png');
  a.download='birka.png';
  a.click();
}

// --- Browser print ---
function browserPrint(){
  const f1=12,f2=10,lh=1.2,pt=0.5;
  const label={
    line1:document.getElementById('l1').value,
    line2:document.getElementById('l2').value,
    line3:document.getElementById('l3').value,
    line4:document.getElementById('l4').value,
    line5:document.getElementById('l5').value
  };
  const html=`
    <div class="print-label" style="padding-top:${pt}mm;line-height:${lh}">
      <div style="font-size:${f1}pt;font-weight:bold">${label.line1||''}</div>
      <div style="font-size:${f2}pt">${label.line2||''}</div>
      <div style="font-size:${f2}pt">${label.line3||''}</div>
      <div style="font-size:${f2}pt">${label.line4||''}</div>
      <div style="font-size:${f2}pt">${label.line5||''}</div>
    </div>`;
  document.getElementById('printArea').innerHTML=html;
  setTimeout(()=>window.print(),200);
}

// events
document.getElementById('usbConnectBtn').addEventListener('click',connectUSB);
document.getElementById('usbPrintBtn').addEventListener('click',printUSB);
document.getElementById('pdfBtn').addEventListener('click',exportPDF);
document.getElementById('pngBtn').addEventListener('click',exportPNG);
document.getElementById('printBtn').addEventListener('click',browserPrint);
</script>
</body>
</html>
