<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–≠–º–∏–ª—å –ë–∏—Ä–∫–∏</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    *{margin:0;padding:0;box-sizing:border-box;}
    body{
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
      background:#e5e7eb;
    }
    .app{max-width:520px;margin:0 auto;padding:12px;}
    h1{font-size:20px;margin:0 0 8px;color:#1f2937;}
    
    .preview-wrap{
      background:#f3f4f6;
      border-radius:12px;
      padding:16px;
      margin-bottom:12px;
      display:flex;
      justify-content:center;
      align-items:center;
      min-height:250px;
    }
    
    .label{
      width:40mm;
      height:30mm;
      border:3px solid #111827;
      background:white;
      position:relative;
      box-sizing:border-box;
    }
    
    .label-line{
      position:absolute;
      left:0;
      width:100%;
      text-align:center;
      white-space:nowrap;
      overflow:visible;
    }
    
    .controls{
      background:white;
      border-radius:12px;
      padding:16px;
      margin-bottom:12px;
    }
    
    .controls input[type="text"]{
      width:100%;
      padding:8px 10px;
      margin-bottom:8px;
      border-radius:8px;
      border:1px solid #d1d5db;
      font-size:14px;
      box-sizing:border-box;
    }
    
    .slider-group{
      margin-bottom:12px;
      padding:10px;
      background:#f9fafb;
      border-radius:8px;
    }
    
    .slider-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:6px;
    }
    
    .slider-label{
      font-size:13px;
      font-weight:600;
      color:#374151;
    }
    
    .slider-value{
      background:#6366f1;
      color:white;
      padding:3px 10px;
      border-radius:12px;
      font-size:11px;
      font-weight:700;
      min-width:45px;
      text-align:center;
    }
    
    .slider{
      width:100%;
      height:6px;
      border-radius:3px;
      outline:none;
      background:#e5e7eb;
    }
    
    .slider::-webkit-slider-thumb{
      -webkit-appearance:none;
      width:20px;
      height:20px;
      background:#6366f1;
      border-radius:50%;
      cursor:pointer;
      border:2px solid white;
      box-shadow:0 2px 6px rgba(0,0,0,0.2);
    }
    
    .slider::-moz-range-thumb{
      width:20px;
      height:20px;
      background:#6366f1;
      border-radius:50%;
      cursor:pointer;
      border:2px solid white;
      box-shadow:0 2px 6px rgba(0,0,0,0.2);
    }
    
    .btn{
      width:100%;
      padding:12px 14px;
      border-radius:8px;
      border:none;
      font-weight:600;
      font-size:14px;
      cursor:pointer;
      margin-bottom:8px;
      color:white;
      transition:all 0.2s;
    }
    
    .btn:hover:not(:disabled){transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,0.15);}
    .btn:active:not(:disabled){transform:translateY(0);}
    .btn:disabled{opacity:.5;cursor:not-allowed;}
    
    .btn-primary{background:#6366f1;}
    .btn-usb{background:#ec4899;}
    .btn-disconnect{background:#f59e0b;}
    .btn-danger{background:#ef4444;}
    .btn-success{background:#10b981;}
    
    .row{display:flex;gap:8px;margin-bottom:8px;}
    .row .btn{flex:1;margin-bottom:0;}
    
    .status{
      font-size:13px;
      margin-bottom:12px;
      padding:10px;
      background:white;
      border-radius:8px;
      font-weight:600;
    }
    
    .hint{
      font-size:12px;
      color:#1f2937;
      margin-bottom:12px;
      padding:10px;
      background:#dcfce7;
      border-radius:8px;
      line-height:1.5;
    }
    
    .section-title{
      font-size:15px;
      font-weight:700;
      color:#1f2937;
      margin-bottom:12px;
      padding-bottom:8px;
      border-bottom:2px solid #e5e7eb;
    }
    
    #printArea{display:none;}
    
    @media print{
      @page{size:40mm 30mm;margin:0;}
      body>*:not(#printArea){display:none!important;}
      #printArea{display:block!important;}
      .print-label{
        width:40mm;
        height:30mm;
        border:2px solid #000;
        box-sizing:border-box;
        padding:0 2mm;
        display:flex;
        flex-direction:column;
        justify-content:center;
        text-align:center;
        font-size:10pt;
        line-height:1.2;
      }
    }
  </style>
</head>
<body>
<div class="app">
  <h1>üè∑Ô∏è –≠–º–∏–ª—å –ë–∏—Ä–∫–∏</h1>

  <div class="hint">
    ‚úÖ –ü–µ—á–∞—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫–æ–π —á–µ—Ä–µ–∑ USB. –ß—Ç–æ –≤–∏–¥–∏—à—å ‚Äî —Ç–æ –∏ –Ω–∞–ø–µ—á–∞—Ç–∞–µ—Ç—Å—è!
  </div>

  <div class="preview-wrap">
    <div class="label" id="label">
      <div class="label-line" id="line1"></div>
      <div class="label-line" id="line2"></div>
      <div class="label-line" id="line3"></div>
      <div class="label-line" id="line4"></div>
      <div class="label-line" id="line5"></div>
    </div>
  </div>

  <div class="controls">
    <div class="section-title">üìù –¢–µ–∫—Å—Ç –±–∏—Ä–∫–∏</div>
    <input id="l1" type="text" placeholder="–°—Ç—Ä–æ–∫–∞ 1" value="1–†–ü3-–ì—Ä.-3.1">
    <input id="l2" type="text" placeholder="–°—Ç—Ä–æ–∫–∞ 2" value="–û—Å–≤–µ—â–µ–Ω–∏–µ —ç–ª–µ–∫—Ç—Ä–æ—â–∏—Ç–æ–≤–æ–π">
    <input id="l3" type="text" placeholder="–°—Ç—Ä–æ–∫–∞ 3" value="–í–í–ì–Ω–≥(–ê)-LSLTx 3√ó1.5">
    <input id="l4" type="text" placeholder="–°—Ç—Ä–æ–∫–∞ 4" value="–æ—Ç 1–†–ü3">
    <input id="l5" type="text" placeholder="–°—Ç—Ä–æ–∫–∞ 5" value="L=15–º">
  </div>

  <div class="controls">
    <div class="section-title">üìè –†–∞–∑–º–µ—Ä—ã —à—Ä–∏—Ñ—Ç–æ–≤ (pt)</div>
    
    <div class="slider-group">
      <div class="slider-header">
        <span class="slider-label">–°—Ç—Ä–æ–∫–∞ 1</span>
        <span class="slider-value" id="f1Val">14</span>
      </div>
      <input type="range" class="slider" id="f1" min="8" max="24" value="14" step="1">
    </div>
    
    <div class="slider-group">
      <div class="slider-header">
        <span class="slider-label">–°—Ç—Ä–æ–∫–∏ 2-5</span>
        <span class="slider-value" id="f2Val">11</span>
      </div>
      <input type="range" class="slider" id="f2" min="7" max="18" value="11" step="1">
    </div>
  </div>

  <div class="controls">
    <div class="section-title">üìç –ü–æ–∑–∏—Ü–∏–∏ —Å—Ç—Ä–æ–∫ (px –æ—Ç –≤–µ—Ä—Ö–∞)</div>
    
    <div class="slider-group">
      <div class="slider-header">
        <span class="slider-label">–°—Ç—Ä–æ–∫–∞ 1</span>
        <span class="slider-value" id="y1Val">15</span>
      </div>
      <input type="range" class="slider" id="y1" min="5" max="80" value="15" step="1">
    </div>
    
    <div class="slider-group">
      <div class="slider-header">
        <span class="slider-label">–°—Ç—Ä–æ–∫–∞ 2</span>
        <span class="slider-value" id="y2Val">40</span>
      </div>
      <input type="range" class="slider" id="y2" min="15" max="100" value="40" step="1">
    </div>
    
    <div class="slider-group">
      <div class="slider-header">
        <span class="slider-label">–°—Ç—Ä–æ–∫–∞ 3</span>
        <span class="slider-value" id="y3Val">60</span>
      </div>
      <input type="range" class="slider" id="y3" min="25" max="110" value="60" step="1">
    </div>
    
    <div class="slider-group">
      <div class="slider-header">
        <span class="slider-label">–°—Ç—Ä–æ–∫–∞ 4</span>
        <span class="slider-value" id="y4Val">80</span>
      </div>
      <input type="range" class="slider" id="y4" min="35" max="120" value="80" step="1">
    </div>
    
    <div class="slider-group">
      <div class="slider-header">
        <span class="slider-label">–°—Ç—Ä–æ–∫–∞ 5</span>
        <span class="slider-value" id="y5Val">100</span>
      </div>
      <input type="range" class="slider" id="y5" min="45" max="130" value="100" step="1">
    </div>
  </div>

  <div class="status" id="usbStatus">üî¥ USB: –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω</div>

  <div class="row">
    <button class="btn btn-usb" id="usbConnectBtn">üîå –ü–æ–¥–∫–ª—é—á–∏—Ç—å</button>
    <button class="btn btn-disconnect" id="usbDisconnectBtn" disabled>üîå –û—Ç–∫–ª—é—á–∏—Ç—å</button>
  </div>
  
  <button class="btn btn-usb" id="usbPrintBtn" disabled>‚ö° –ü–µ—á–∞—Ç—å —á–µ—Ä–µ–∑ USB</button>

  <div class="row">
    <button class="btn btn-primary" id="pdfBtn">üìÑ PDF</button>
    <button class="btn btn-danger" id="printBtn">üñ®Ô∏è –ü–µ—á–∞—Ç—å</button>
  </div>

  <div id="printArea"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
let usbDevice=null;
let usbEndpoint=1;

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫
function loadSettings(){
  const saved=localStorage.getItem('birka_settings');
  if(!saved) return;
  
  try{
    const data=JSON.parse(saved);
    ['l1','l2','l3','l4','l5'].forEach(id=>{
      if(data[id]) document.getElementById(id).value=data[id];
    });
    ['f1','f2','y1','y2','y3','y4','y5'].forEach(id=>{
      if(data[id]) document.getElementById(id).value=data[id];
    });
  }catch(e){
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:',e);
  }
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫
function saveSettings(){
  const data={};
  ['l1','l2','l3','l4','l5','f1','f2','y1','y2','y3','y4','y5'].forEach(id=>{
    data[id]=document.getElementById(id).value;
  });
  localStorage.setItem('birka_settings',JSON.stringify(data));
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–≤—å—é
function updatePreview(){
  for(let i=1;i<=5;i++){
    const line=document.getElementById('line'+i);
    const text=document.getElementById('l'+i).value;
    const y=parseInt(document.getElementById('y'+i).value);
    const fontSize=i===1?parseInt(document.getElementById('f1').value):parseInt(document.getElementById('f2').value);
    
    line.textContent=text;
    line.style.top=y+'px';
    line.style.fontSize=fontSize+'pt';
    line.style.fontWeight=i===1?'bold':'normal';
  }
  saveSettings();
}

function updateSliderValues(){
  document.getElementById('f1Val').textContent=document.getElementById('f1').value+'pt';
  document.getElementById('f2Val').textContent=document.getElementById('f2').value+'pt';
  for(let i=1;i<=5;i++){
    document.getElementById('y'+i+'Val').textContent=document.getElementById('y'+i).value+'px';
  }
}

['l1','l2','l3','l4','l5'].forEach(id=>{
  document.getElementById(id).addEventListener('input',updatePreview);
});

['f1','f2','y1','y2','y3','y4','y5'].forEach(id=>{
  document.getElementById(id).addEventListener('input',()=>{
    updatePreview();
    updateSliderValues();
  });
});

loadSettings();
updatePreview();
updateSliderValues();

// USB –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
async function connectUSB(){
  if(!navigator.usb){
    alert('‚ùå WebUSB —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤ Chrome/Edge');
    return;
  }
  try{
    usbDevice=await navigator.usb.requestDevice({
      filters:[{vendorId:0x0416},{vendorId:0x1FC9},{classCode:7}]
    });
    await usbDevice.open();
    if(!usbDevice.configuration) await usbDevice.selectConfiguration(1);
    const iface=usbDevice.configuration.interfaces[0];
    await usbDevice.claimInterface(iface.interfaceNumber);
    const outEp=iface.alternate.endpoints.find(e=>e.direction==='out');
    if(outEp) usbEndpoint=outEp.endpointNumber;
    
    document.getElementById('usbStatus').textContent='üü¢ USB: '+(usbDevice.productName||'–ø–æ–¥–∫–ª—é—á–µ–Ω');
    document.getElementById('usbPrintBtn').disabled=false;
    document.getElementById('usbConnectBtn').disabled=true;
    document.getElementById('usbDisconnectBtn').disabled=false;
  }catch(e){
    alert('‚ùå '+e.message);
  }
}

async function disconnectUSB(){
  if(!usbDevice) return;
  try{
    await usbDevice.close();
    usbDevice=null;
    document.getElementById('usbStatus').textContent='üî¥ USB: –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω';
    document.getElementById('usbPrintBtn').disabled=true;
    document.getElementById('usbConnectBtn').disabled=false;
    document.getElementById('usbDisconnectBtn').disabled=true;
  }catch(e){
    alert('‚ùå '+e.message);
  }
}

// USB –ø–µ—á–∞—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫–æ–π
async function printUSB(){
  if(!usbDevice){alert('‚ùå –ü–æ–¥–∫–ª—é—á–∏ –ø—Ä–∏–Ω—Ç–µ—Ä');return;}
  
  try{
    const canvas=await html2canvas(document.getElementById('label'),{
      scale:2,
      backgroundColor:'#ffffff'
    });
    
    const ctx=canvas.getContext('2d');
    const imgData=ctx.getImageData(0,0,canvas.width,canvas.height);
    const pixels=imgData.data;
    
    const w=canvas.width;
    const h=canvas.height;
    const bytesPerRow=Math.ceil(w/8);
    
    const bitmapBytes=[];
    for(let y=0;y<h;y++){
      let bits='';
      for(let x=0;x<w;x++){
        const i=(y*w+x)*4;
        const brightness=(pixels[i]+pixels[i+1]+pixels[i+2])/3;
        bits+=brightness<128?'0':'1';
      }
      while(bits.length%8!==0) bits+='1';
      
      for(let i=0;i<bits.length;i+=8){
        const byte=parseInt(bits.substring(i,i+8),2);
        bitmapBytes.push(byte);
      }
    }
    
    let cmd='';
    cmd+='SIZE 40 mm,30 mm\r\n';
    cmd+='GAP 2 mm,0 mm\r\n';
    cmd+='DIRECTION 1\r\n';
    cmd+='CLS\r\n';
    cmd+=`BITMAP 0,0,${bytesPerRow},${h},1,`;
    
    const cmdBytes=[];
    for(let i=0;i<cmd.length;i++){
      cmdBytes.push(cmd.charCodeAt(i));
    }
    
    cmdBytes.push(...bitmapBytes);
    
    const footer='\r\nPRINT 1,1\r\n';
    for(let i=0;i<footer.length;i++){
      cmdBytes.push(footer.charCodeAt(i));
    }
    
    const data=new Uint8Array(cmdBytes);
    console.log('–û—Ç–ø—Ä–∞–≤–∫–∞:',data.length,'–±–∞–π—Ç');
    
    await usbDevice.transferOut(usbEndpoint,data);
    alert('‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!');
    
  }catch(e){
    console.error(e);
    alert('‚ùå –û—à–∏–±–∫–∞: '+e.message);
  }
}

// PDF —ç–∫—Å–ø–æ—Ä—Ç (–∞–ª—å–±–æ–º–Ω–∞—è 40√ó30–º–º)
async function exportPDF(){
  try{
    const canvas=await html2canvas(document.getElementById('label'),{
      scale:3,
      backgroundColor:'#ffffff'
    });
    
    const {jsPDF}=window.jspdf;
    const pdf=new jsPDF({
      orientation:'landscape',
      unit:'mm',
      format:[40,30]
    });
    
    pdf.addImage(canvas.toDataURL('image/png'),'PNG',0,0,40,30);
    pdf.save('birka.pdf');
  }catch(e){
    alert('‚ùå '+e.message);
  }
}

// –û–±—ã—á–Ω–∞—è –ø–µ—á–∞—Ç—å
function browserPrint(){
  const f1=parseInt(document.getElementById('f1').value);
  const f2=parseInt(document.getElementById('f2').value);
  
  const html=`
    <div class="print-label" style="line-height:1.3">
      <div style="font-size:${f1}pt;font-weight:bold;margin-bottom:6px">${document.getElementById('l1').value}</div>
      <div style="font-size:${f2}pt;margin-bottom:3px">${document.getElementById('l2').value}</div>
      <div style="font-size:${f2}pt;margin-bottom:3px">${document.getElementById('l3').value}</div>
      <div style="font-size:${f2}pt;margin-bottom:3px">${document.getElementById('l4').value}</div>
      <div style="font-size:${f2}pt">${document.getElementById('l5').value}</div>
    </div>`;
  document.getElementById('printArea').innerHTML=html;
  setTimeout(()=>window.print(),200);
}

// –°–æ–±—ã—Ç–∏—è
document.getElementById('usbConnectBtn').addEventListener('click',connectUSB);
document.getElementById('usbDisconnectBtn').addEventListener('click',disconnectUSB);
document.getElementById('usbPrintBtn').addEventListener('click',printUSB);
document.getElementById('pdfBtn').addEventListener('click',exportPDF);
document.getElementById('printBtn').addEventListener('click',browserPrint);
</script>
</body>
</html>

