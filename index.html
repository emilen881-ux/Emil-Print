<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–≠–º–∏–ª—å –ë–∏—Ä–∫–∏ ‚Äî —Ç–æ—á–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body{
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
      background:#e5e7eb;
      margin:0;
    }
    .app{max-width:520px;margin:0 auto;padding:12px;}
    h1{font-size:20px;margin:0 0 8px;}
    
    .preview-wrap{
      background:#f3f4f6;
      border-radius:12px;
      padding:16px;
      margin-bottom:12px;
      display:flex;
      justify-content:center;
      align-items:center;
      min-height:250px;
    }
    
    .label{
      width:40mm;
      height:30mm;
      border:3px solid #111827;
      background:white;
      position:relative;
      box-sizing:border-box;
    }
    
    .label-line{
      position:absolute;
      left:0;
      width:100%;
      text-align:center;
      white-space:nowrap;
      overflow:visible;
    }
    
    .controls{
      background:white;
      border-radius:12px;
      padding:16px;
      margin-bottom:12px;
    }
    
    .controls input[type="text"]{
      width:100%;
      padding:8px 10px;
      margin-bottom:8px;
      border-radius:8px;
      border:1px solid #d1d5db;
      font-size:14px;
      box-sizing:border-box;
    }
    
    .slider-group{
      margin-bottom:16px;
      padding:12px;
      background:#f9fafb;
      border-radius:8px;
    }
    
    .slider-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:8px;
    }
    
    .slider-label{
      font-size:13px;
      font-weight:600;
      color:#374151;
    }
    
    .slider-value{
      background:#6366f1;
      color:white;
      padding:4px 12px;
      border-radius:12px;
      font-size:12px;
      font-weight:700;
      min-width:50px;
      text-align:center;
    }
    
    .slider{
      width:100%;
      height:8px;
      border-radius:4px;
      outline:none;
      background:#e5e7eb;
    }
    
    .slider::-webkit-slider-thumb{
      -webkit-appearance:none;
      width:24px;
      height:24px;
      background:#6366f1;
      border-radius:50%;
      cursor:pointer;
      border:3px solid white;
      box-shadow:0 2px 8px rgba(0,0,0,0.2);
    }
    
    .slider::-moz-range-thumb{
      width:24px;
      height:24px;
      background:#6366f1;
      border-radius:50%;
      cursor:pointer;
      border:3px solid white;
      box-shadow:0 2px 8px rgba(0,0,0,0.2);
    }
    
    .btn{
      width:100%;
      padding:12px 14px;
      border-radius:8px;
      border:none;
      font-weight:600;
      font-size:14px;
      cursor:pointer;
      margin-bottom:8px;
      color:white;
      transition:all 0.2s;
    }
    
    .btn:hover:not(:disabled){transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,0.15);}
    .btn:active:not(:disabled){transform:translateY(0);}
    .btn:disabled{opacity:.5;cursor:not-allowed;}
    
    .btn-primary{background:#6366f1;}
    .btn-usb{background:#ec4899;}
    .btn-disconnect{background:#f59e0b;}
    .btn-danger{background:#ef4444;}
    .btn-success{background:#10b981;}
    
    .row{display:flex;gap:8px;margin-bottom:8px;}
    .row .btn{flex:1;margin-bottom:0;}
    
    .status{
      font-size:13px;
      margin-bottom:12px;
      padding:10px;
      background:white;
      border-radius:8px;
      font-weight:600;
    }
    
    .hint{
      font-size:12px;
      color:#1f2937;
      margin-bottom:12px;
      padding:10px;
      background:#fef3c7;
      border-radius:8px;
      line-height:1.5;
    }
    
    .section-title{
      font-size:15px;
      font-weight:700;
      color:#1f2937;
      margin-bottom:12px;
      padding-bottom:8px;
      border-bottom:2px solid #e5e7eb;
    }
    
    #printArea{display:none;}
    
    @media print{
      @page{size:40mm 30mm;margin:0;}
      body>*:not(#printArea){display:none!important;}
      #printArea{display:block!important;}
      .print-label{
        width:40mm;
        height:30mm;
        border:2px solid #000;
        box-sizing:border-box;
        padding:0 2mm;
        display:flex;
        flex-direction:column;
        justify-content:center;
        text-align:center;
        font-size:10pt;
        line-height:1.2;
      }
    }
  </style>
</head>
<body>
<div class="app">
  <h1>üè∑Ô∏è –≠–º–∏–ª—å –ë–∏—Ä–∫–∏ ‚Äî —Ç–æ—á–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞</h1>

  <div class="hint">
    üí° –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–π –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∏ —Ä–∞–∑–º–µ—Ä—ã —Å–ª–∞–π–¥–µ—Ä–∞–º–∏. –ü—Ä–µ–≤—å—é –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–æ—á–Ω–æ–µ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –Ω–∞ –±–∏—Ä–∫–µ 40√ó30–º–º.
  </div>

  <div class="preview-wrap">
    <div class="label" id="label">
      <div class="label-line" id="line1"></div>
      <div class="label-line" id="line2"></div>
      <div class="label-line" id="line3"></div>
      <div class="label-line" id="line4"></div>
      <div class="label-line" id="line5"></div>
    </div>
  </div>

  <div class="controls">
    <div class="section-title">üìù –¢–µ–∫—Å—Ç –±–∏—Ä–∫–∏</div>
    <input id="l1" type="text" placeholder="–°—Ç—Ä–æ–∫–∞ 1" value="1–†–ü3-–ì—Ä.-3.1">
    <input id="l2" type="text" placeholder="–°—Ç—Ä–æ–∫–∞ 2" value="–û—Å–≤–µ—â–µ–Ω–∏–µ —ç–ª–µ–∫—Ç—Ä–æ—â–∏—Ç–æ–≤–æ–π">
    <input id="l3" type="text" placeholder="–°—Ç—Ä–æ–∫–∞ 3" value="–í–í–ì–Ω–≥(–ê)-LSLTx 3√ó1.5">
    <input id="l4" type="text" placeholder="–°—Ç—Ä–æ–∫–∞ 4" value="–æ—Ç 1–†–ü3">
    <input id="l5" type="text" placeholder="–°—Ç—Ä–æ–∫–∞ 5" value="L=15–º">
  </div>

  <div class="controls">
    <div class="section-title">üìè –†–∞–∑–º–µ—Ä—ã —à—Ä–∏—Ñ—Ç–æ–≤ (pt)</div>
    
    <div class="slider-group">
      <div class="slider-header">
        <span class="slider-label">–°—Ç—Ä–æ–∫–∞ 1</span>
        <span class="slider-value" id="f1Val">14</span>
      </div>
      <input type="range" class="slider" id="f1" min="8" max="24" value="14" step="1">
    </div>
    
    <div class="slider-group">
      <div class="slider-header">
        <span class="slider-label">–°—Ç—Ä–æ–∫–∏ 2-5</span>
        <span class="slider-value" id="f2Val">11</span>
      </div>
      <input type="range" class="slider" id="f2" min="7" max="18" value="11" step="1">
    </div>
  </div>

  <div class="controls">
    <div class="section-title">üìç –ü–æ–∑–∏—Ü–∏–∏ —Å—Ç—Ä–æ–∫ (px –æ—Ç –≤–µ—Ä—Ö–∞)</div>
    
    <div class="slider-group">
      <div class="slider-header">
        <span class="slider-label">–°—Ç—Ä–æ–∫–∞ 1</span>
        <span class="slider-value" id="y1Val">30</span>
      </div>
      <input type="range" class="slider" id="y1" min="10" max="80" value="30" step="2">
    </div>
    
    <div class="slider-group">
      <div class="slider-header">
        <span class="slider-label">–°—Ç—Ä–æ–∫–∞ 2</span>
        <span class="slider-value" id="y2Val">60</span>
      </div>
      <input type="range" class="slider" id="y2" min="20" max="100" value="60" step="2">
    </div>
    
    <div class="slider-group">
      <div class="slider-header">
        <span class="slider-label">–°—Ç—Ä–æ–∫–∞ 3</span>
        <span class="slider-value" id="y3Val">80</span>
      </div>
      <input type="range" class="slider" id="y3" min="30" max="120" value="80" step="2">
    </div>
    
    <div class="slider-group">
      <div class="slider-header">
        <span class="slider-label">–°—Ç—Ä–æ–∫–∞ 4</span>
        <span class="slider-value" id="y4Val">100</span>
      </div>
      <input type="range" class="slider" id="y4" min="40" max="130" value="100" step="2">
    </div>
    
    <div class="slider-group">
      <div class="slider-header">
        <span class="slider-label">–°—Ç—Ä–æ–∫–∞ 5</span>
        <span class="slider-value" id="y5Val">120</span>
      </div>
      <input type="range" class="slider" id="y5" min="50" max="140" value="120" step="2">
    </div>
  </div>

  <div class="controls">
    <div class="section-title">‚öôÔ∏è TSPL –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</div>
    
    <div class="slider-group">
      <div class="slider-header">
        <span class="slider-label">üîÑ DIRECTION (–ø–æ–≤–æ—Ä–æ—Ç)</span>
        <span class="slider-value" id="dirVal">1</span>
      </div>
      <input type="range" class="slider" id="direction" min="0" max="3" value="1" step="1">
    </div>
  </div>

  <div class="status" id="usbStatus">üî¥ USB: –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω</div>

  <div class="row">
    <button class="btn btn-usb" id="usbConnectBtn">üîå –ü–æ–¥–∫–ª—é—á–∏—Ç—å</button>
    <button class="btn btn-disconnect" id="usbDisconnectBtn" disabled>üîå –û—Ç–∫–ª—é—á–∏—Ç—å</button>
  </div>
  
  <button class="btn btn-usb" id="usbPrintBtn" disabled>‚ö° –ü–µ—á–∞—Ç—å —á–µ—Ä–µ–∑ USB (CP866)</button>

  <div class="row">
    <button class="btn btn-primary" id="pdfBtn">üìÑ PDF</button>
    <button class="btn btn-success" id="pngBtn">üñºÔ∏è PNG</button>
  </div>

  <button class="btn btn-danger" id="printBtn">üñ®Ô∏è –û–±—ã—á–Ω–∞—è –ø–µ—á–∞—Ç—å</button>

  <div id="printArea"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
let usbDevice=null;
let usbEndpoint=1;

// –ü—Ä–µ–≤—å—é —Å —Ç–æ—á–Ω—ã–º–∏ –ø–æ–∑–∏—Ü–∏—è–º–∏
function updatePreview(){
  for(let i=1;i<=5;i++){
    const line=document.getElementById('line'+i);
    const text=document.getElementById('l'+i).value;
    const y=parseInt(document.getElementById('y'+i).value);
    const fontSize=i===1 ? parseInt(document.getElementById('f1').value) : parseInt(document.getElementById('f2').value);
    
    line.textContent=text;
    line.style.top=y+'px';
    line.style.fontSize=fontSize+'pt';
    line.style.fontWeight=i===1?'bold':'normal';
  }
}

function updateSliderValues(){
  document.getElementById('f1Val').textContent=document.getElementById('f1').value+'pt';
  document.getElementById('f2Val').textContent=document.getElementById('f2').value+'pt';
  for(let i=1;i<=5;i++){
    document.getElementById('y'+i+'Val').textContent=document.getElementById('y'+i).value+'px';
  }
  document.getElementById('dirVal').textContent=document.getElementById('direction').value;
}

['l1','l2','l3','l4','l5'].forEach(id=>{
  document.getElementById(id).addEventListener('input',updatePreview);
});

['f1','f2','y1','y2','y3','y4','y5','direction'].forEach(id=>{
  document.getElementById(id).addEventListener('input',()=>{
    updatePreview();
    updateSliderValues();
  });
});

updatePreview();
updateSliderValues();

// CP866 —Ç–∞–±–ª–∏—Ü–∞
const cp866Map={
  '–ê':0x80,'–ë':0x81,'–í':0x82,'–ì':0x83,'–î':0x84,'–ï':0x85,'–ñ':0x86,'–ó':0x87,'–ò':0x88,'–ô':0x89,
  '–ö':0x8A,'–õ':0x8B,'–ú':0x8C,'–ù':0x8D,'–û':0x8E,'–ü':0x8F,'–†':0x90,'–°':0x91,'–¢':0x92,'–£':0x93,
  '–§':0x94,'–•':0x95,'–¶':0x96,'–ß':0x97,'–®':0x98,'–©':0x99,'–™':0x9A,'–´':0x9B,'–¨':0x9C,'–≠':0x9D,
  '–Æ':0x9E,'–Ø':0x9F,'–∞':0xA0,'–±':0xA1,'–≤':0xA2,'–≥':0xA3,'–¥':0xA4,'–µ':0xA5,'–∂':0xA6,'–∑':0xA7,
  '–∏':0xA8,'–π':0xA9,'–∫':0xAA,'–ª':0xAB,'–º':0xAC,'–Ω':0xAD,'–æ':0xAE,'–ø':0xAF,'—Ä':0xE0,'—Å':0xE1,
  '—Ç':0xE2,'—É':0xE3,'—Ñ':0xE4,'—Ö':0xE5,'—Ü':0xE6,'—á':0xE7,'—à':0xE8,'—â':0xE9,'—ä':0xEA,'—ã':0xEB,
  '—å':0xEC,'—ç':0xED,'—é':0xEE,'—è':0xEF,'–Å':0xF0,'—ë':0xF1
};

function toCP866(str){
  const arr=[];
  for(let i=0;i<str.length;i++){
    const ch=str[i];
    arr.push(cp866Map[ch]!==undefined?cp866Map[ch]:(ch.charCodeAt(0)&0xFF));
  }
  return new Uint8Array(arr);
}

// TSPL –∫–æ–º–∞–Ω–¥–∞
function buildTSPL(){
  const dir=parseInt(document.getElementById('direction').value);
  
  let cmdHeader='';
  cmdHeader+='SIZE 40 mm,30 mm\r\n';
  cmdHeader+='GAP 2 mm,0 mm\r\n';
  cmdHeader+=`DIRECTION ${dir}\r\n`;
  cmdHeader+='REFERENCE 0,0\r\n';
  cmdHeader+='CODEPAGE 866\r\n';
  cmdHeader+='CLS\r\n';

  const headerBytes=[];
  for(let i=0;i<cmdHeader.length;i++){
    headerBytes.push(cmdHeader.charCodeAt(i));
  }

  const bodyBytes=[];
  
  for(let i=1;i<=5;i++){
    const text=document.getElementById('l'+i).value;
    if(!text) continue;
    
    const y=parseInt(document.getElementById('y'+i).value);
    const font=i===1?'4':'3';
    
    // TEXT 10,y,"font",0,1,1,"text"
    const prefix=`TEXT 10,${y},"${font}",0,1,1,"`;
    for(let j=0;j<prefix.length;j++){
      bodyBytes.push(prefix.charCodeAt(j));
    }
    
    const textBytes=toCP866(text);
    bodyBytes.push(...textBytes);
    
    bodyBytes.push(34,13,10); // "\r\n
  }

  const footer='PRINT 1,1\r\n';
  for(let i=0;i<footer.length;i++){
    bodyBytes.push(footer.charCodeAt(i));
  }

  return new Uint8Array([...headerBytes,...bodyBytes]);
}

// USB
async function connectUSB(){
  if(!navigator.usb){
    alert('‚ùå WebUSB —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤ Chrome/Edge');
    return;
  }
  try{
    usbDevice=await navigator.usb.requestDevice({
      filters:[{vendorId:0x0416},{vendorId:0x1FC9},{classCode:7}]
    });
    await usbDevice.open();
    if(!usbDevice.configuration) await usbDevice.selectConfiguration(1);
    const iface=usbDevice.configuration.interfaces[0];
    await usbDevice.claimInterface(iface.interfaceNumber);
    const outEp=iface.alternate.endpoints.find(e=>e.direction==='out');
    if(outEp) usbEndpoint=outEp.endpointNumber;
    
    document.getElementById('usbStatus').textContent='üü¢ USB: '+( usbDevice.productName||'–ø–æ–¥–∫–ª—é—á–µ–Ω');
    document.getElementById('usbPrintBtn').disabled=false;
    document.getElementById('usbConnectBtn').disabled=true;
    document.getElementById('usbDisconnectBtn').disabled=false;
  }catch(e){
    alert('‚ùå '+e.message);
  }
}

async function disconnectUSB(){
  if(!usbDevice) return;
  try{
    await usbDevice.close();
    usbDevice=null;
    document.getElementById('usbStatus').textContent='üî¥ USB: –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω';
    document.getElementById('usbPrintBtn').disabled=true;
    document.getElementById('usbConnectBtn').disabled=false;
    document.getElementById('usbDisconnectBtn').disabled=true;
  }catch(e){
    alert('‚ùå '+e.message);
  }
}

async function printUSB(){
  if(!usbDevice){alert('‚ùå –ü–æ–¥–∫–ª—é—á–∏ –ø—Ä–∏–Ω—Ç–µ—Ä');return;}
  const bytes=buildTSPL();
  try{
    await usbDevice.transferOut(usbEndpoint,bytes);
    alert('‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!');
  }catch(e){
    alert('‚ùå '+e.message);
  }
}

// PDF/PNG/Print
async function exportPDF(){
  const {jsPDF}=window.jspdf;
  const pdf=new jsPDF({orientation:'landscape',unit:'mm',format:[40,30]});
  const canvas=await html2canvas(document.getElementById('label'),{scale:2,backgroundColor:'#fff'});
  pdf.addImage(canvas.toDataURL('image/png'),'PNG',0,0,40,30);
  pdf.save('birka.pdf');
}

async function exportPNG(){
  const canvas=await html2canvas(document.getElementById('label'),{scale:2,backgroundColor:'#fff'});
  const a=document.createElement('a');
  a.href=canvas.toDataURL('image/png');
  a.download='birka.png';
  a.click();
}

function browserPrint(){
  const f1=parseInt(document.getElementById('f1').value);
  const f2=parseInt(document.getElementById('f2').value);
  const y1=parseInt(document.getElementById('y1').value);
  const y2=parseInt(document.getElementById('y2').value);
  const y3=parseInt(document.getElementById('y3').value);
  const y4=parseInt(document.getElementById('y4').value);
  const y5=parseInt(document.getElementById('y5').value);
  
  const html=`
    <div class="print-label">
      <div style="font-size:${f1}pt;font-weight:bold;margin-bottom:${y2-y1-f1*1.5}px">${document.getElementById('l1').value}</div>
      <div style="font-size:${f2}pt;margin-bottom:${y3-y2-f2*1.5}px">${document.getElementById('l2').value}</div>
      <div style="font-size:${f2}pt;margin-bottom:${y4-y3-f2*1.5}px">${document.getElementById('l3').value}</div>
      <div style="font-size:${f2}pt;margin-bottom:${y5-y4-f2*1.5}px">${document.getElementById('l4').value}</div>
      <div style="font-size:${f2}pt">${document.getElementById('l5').value}</div>
    </div>`;
  document.getElementById('printArea').innerHTML=html;
  setTimeout(()=>window.print(),200);
}

// Events
document.getElementById('usbConnectBtn').addEventListener('click',connectUSB);
document.getElementById('usbDisconnectBtn').addEventListener('click',disconnectUSB);
document.getElementById('usbPrintBtn').addEventListener('click',printUSB);
document.getElementById('pdfBtn').addEventListener('click',exportPDF);
document.getElementById('pngBtn').addEventListener('click',exportPNG);
document.getElementById('printBtn').addEventListener('click',browserPrint);
</script>
</body>
</html>
