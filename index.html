<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–≠–º–∏–ª—å –ë–∏—Ä–∫–∏ ‚Äî CP866</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body{
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
      background:#e5e7eb;
      margin:0;
    }
    .app{max-width:480px;margin:0 auto;padding:12px;}
    h1{font-size:20px;margin:0 0 8px;}
    .preview-wrap{
      background:#f3f4f6;
      border-radius:12px;
      padding:16px;
      margin-bottom:12px;
      display:flex;
      justify-content:center;
    }
    .label{
      width:40mm;
      height:30mm;
      border:2px solid #111827;
      background:white;
      display:flex;
      flex-direction:column;
      justify-content:center;
      text-align:center;
      padding:1mm 2mm;
      box-sizing:border-box;
      line-height:1.2;
    }
    .label .l1{font-size:12pt;font-weight:bold;}
    .label .l2,.label .l3,.label .l4,.label .l5{font-size:10pt;}
    .controls input[type="text"]{
      width:100%;
      padding:8px 10px;
      margin-bottom:6px;
      border-radius:8px;
      border:1px solid #d1d5db;
      font-size:14px;
      box-sizing:border-box;
    }
    .slider-group{
      margin-bottom:12px;
      padding:12px;
      background:white;
      border-radius:8px;
    }
    .slider-group label{
      display:flex;
      justify-content:space-between;
      font-size:13px;
      font-weight:600;
      margin-bottom:6px;
    }
    .slider{
      width:100%;
      height:6px;
      border-radius:3px;
      outline:none;
    }
    .btn{
      width:100%;
      padding:10px 14px;
      border-radius:8px;
      border:none;
      font-weight:600;
      font-size:14px;
      cursor:pointer;
      margin-bottom:6px;
      color:white;
    }
    .btn-primary{background:#6366f1;}
    .btn-usb{background:#ec4899;}
    .btn-disconnect{background:#f59e0b;}
    .btn-danger{background:#ef4444;}
    .btn:disabled{opacity:.5;cursor:not-allowed;}
    .row{display:flex;gap:6px;margin-bottom:6px;}
    .row .btn{flex:1;margin-bottom:0;}
    .status{
      font-size:13px;
      margin-bottom:8px;
      padding:8px;
      background:white;
      border-radius:8px;
    }
    .hint{
      font-size:12px;
      color:#6b7280;
      margin-bottom:8px;
      padding:8px;
      background:#dbeafe;
      border-radius:8px;
    }
    #printArea{display:none;}
    @media print{
      @page{size:40mm 30mm;margin:0;}
      body>*:not(#printArea){display:none!important;}
      #printArea{display:block!important;}
      .print-label{
        width:40mm;
        height:30mm;
        border:2px solid #000;
        box-sizing:border-box;
        padding:0 2mm;
        display:flex;
        flex-direction:column;
        justify-content:center;
        text-align:center;
        font-size:10pt;
        line-height:1.2;
      }
    }
  </style>
</head>
<body>
<div class="app">
  <h1>üè∑Ô∏è –≠–º–∏–ª—å –ë–∏—Ä–∫–∏ ‚Äî TSPL CP866</h1>

  <div class="hint">
    ‚úÖ –ö–æ–¥–∏—Ä–æ–≤–∫–∞ CP866 (DOS) –¥–ª—è XP-365B
  </div>

  <div class="preview-wrap">
    <div class="label" id="preview">
      <div class="l1"></div>
      <div class="l2"></div>
      <div class="l3"></div>
      <div class="l4"></div>
      <div class="l5"></div>
    </div>
  </div>

  <div class="controls">
    <input id="l1" type="text" placeholder="–°—Ç—Ä–æ–∫–∞ 1" value="1–†–ü3-–ì—Ä.-3.1">
    <input id="l2" type="text" placeholder="–°—Ç—Ä–æ–∫–∞ 2" value="–û—Å–≤–µ—â–µ–Ω–∏–µ —ç–ª–µ–∫—Ç—Ä–æ—â–∏—Ç–æ–≤–æ–π">
    <input id="l3" type="text" placeholder="–°—Ç—Ä–æ–∫–∞ 3" value="–í–í–ì–Ω–≥(–ê)-LSLTx 3√ó1.5">
    <input id="l4" type="text" placeholder="–°—Ç—Ä–æ–∫–∞ 4" value="–æ—Ç 1–†–ü3">
    <input id="l5" type="text" placeholder="–°—Ç—Ä–æ–∫–∞ 5" value="L=15–º">
  </div>

  <div class="slider-group">
    <label>
      <span>üìç Y –Ω–∞—á–∞–ª–æ (–æ—Ç—Å—Ç—É–ø —Å–≤–µ—Ä—Ö—É)</span>
      <span id="yStartVal">10</span>
    </label>
    <input type="range" class="slider" id="yStart" min="0" max="50" value="10" step="1">
  </div>

  <div class="slider-group">
    <label>
      <span>‚ÜïÔ∏è –ò–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É —Å—Ç—Ä–æ–∫–∞–º–∏</span>
      <span id="yStepVal">25</span>
    </label>
    <input type="range" class="slider" id="yStep" min="15" max="40" value="25" step="1">
  </div>

  <div class="slider-group">
    <label>
      <span>‚ÜîÔ∏è X –æ—Ç—Å—Ç—É–ø —Å–ª–µ–≤–∞</span>
      <span id="xLeftVal">10</span>
    </label>
    <input type="range" class="slider" id="xLeft" min="0" max="50" value="10" step="1">
  </div>

  <div class="slider-group">
    <label>
      <span>üîÑ –ü–æ–≤–æ—Ä–æ—Ç (DIRECTION)</span>
      <span id="dirVal">1</span>
    </label>
    <input type="range" class="slider" id="direction" min="0" max="3" value="1" step="1">
  </div>

  <div class="status" id="usbStatus">üî¥ USB: –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω</div>

  <div class="row">
    <button class="btn btn-usb" id="usbConnectBtn">üîå –ü–æ–¥–∫–ª—é—á–∏—Ç—å</button>
    <button class="btn btn-disconnect" id="usbDisconnectBtn" disabled>üîå –û—Ç–∫–ª—é—á–∏—Ç—å</button>
  </div>
  
  <button class="btn btn-usb" id="usbPrintBtn" disabled>‚ö° –ü–µ—á–∞—Ç—å —á–µ—Ä–µ–∑ USB (TSPL + CP866)</button>

  <div class="row">
    <button class="btn btn-primary" id="pdfBtn">üìÑ PDF</button>
    <button class="btn btn-primary" id="pngBtn">üñºÔ∏è PNG</button>
  </div>

  <button class="btn btn-danger" id="printBtn">üñ®Ô∏è –û–±—ã—á–Ω–∞—è –ø–µ—á–∞—Ç—å</button>

  <div id="printArea"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
let usbDevice=null;
let usbEndpoint=1;

// –ü—Ä–µ–≤—å—é –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
function updatePreview(){
  const p=document.getElementById('preview');
  const lines=p.querySelectorAll('div');
  for(let i=1;i<=5;i++){
    lines[i-1].textContent=document.getElementById('l'+i).value;
  }
}

function updateSliderValues(){
  document.getElementById('yStartVal').textContent=document.getElementById('yStart').value;
  document.getElementById('yStepVal').textContent=document.getElementById('yStep').value;
  document.getElementById('xLeftVal').textContent=document.getElementById('xLeft').value;
  document.getElementById('dirVal').textContent=document.getElementById('direction').value;
}

['l1','l2','l3','l4','l5'].forEach(id=>{
  document.getElementById(id).addEventListener('input',updatePreview);
});

['yStart','yStep','xLeft','direction'].forEach(id=>{
  document.getElementById(id).addEventListener('input',updateSliderValues);
});

updatePreview();
updateSliderValues();

// –¢–∞–±–ª–∏—Ü–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ UTF-8 ‚Üí CP866 (DOS –∫–∏—Ä–∏–ª–ª–∏—Ü–∞)
const cp866Map={
  '–ê':0x80,'–ë':0x81,'–í':0x82,'–ì':0x83,'–î':0x84,'–ï':0x85,'–ñ':0x86,'–ó':0x87,'–ò':0x88,'–ô':0x89,
  '–ö':0x8A,'–õ':0x8B,'–ú':0x8C,'–ù':0x8D,'–û':0x8E,'–ü':0x8F,'–†':0x90,'–°':0x91,'–¢':0x92,'–£':0x93,
  '–§':0x94,'–•':0x95,'–¶':0x96,'–ß':0x97,'–®':0x98,'–©':0x99,'–™':0x9A,'–´':0x9B,'–¨':0x9C,'–≠':0x9D,
  '–Æ':0x9E,'–Ø':0x9F,'–∞':0xA0,'–±':0xA1,'–≤':0xA2,'–≥':0xA3,'–¥':0xA4,'–µ':0xA5,'–∂':0xA6,'–∑':0xA7,
  '–∏':0xA8,'–π':0xA9,'–∫':0xAA,'–ª':0xAB,'–º':0xAC,'–Ω':0xAD,'–æ':0xAE,'–ø':0xAF,'—Ä':0xE0,'—Å':0xE1,
  '—Ç':0xE2,'—É':0xE3,'—Ñ':0xE4,'—Ö':0xE5,'—Ü':0xE6,'—á':0xE7,'—à':0xE8,'—â':0xE9,'—ä':0xEA,'—ã':0xEB,
  '—å':0xEC,'—ç':0xED,'—é':0xEE,'—è':0xEF,'–Å':0xF0,'—ë':0xF1
};

function toCP866(str){
  const arr=[];
  for(let i=0;i<str.length;i++){
    const ch=str[i];
    if(cp866Map[ch]!==undefined){
      arr.push(cp866Map[ch]);
    }else{
      arr.push(ch.charCodeAt(0)&0xFF);
    }
  }
  return new Uint8Array(arr);
}

// --- TSPL –∫–æ–º–∞–Ω–¥–∞ —Å CP866 ---
function buildTSPL(){
  const l1=document.getElementById('l1').value;
  const l2=document.getElementById('l2').value;
  const l3=document.getElementById('l3').value;
  const l4=document.getElementById('l4').value;
  const l5=document.getElementById('l5').value;

  const yStart=parseInt(document.getElementById('yStart').value);
  const yStep=parseInt(document.getElementById('yStep').value);
  const xLeft=parseInt(document.getElementById('xLeft').value);
  const dir=parseInt(document.getElementById('direction').value);

  let y=yStart;

  // –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∫–æ–º–∞–Ω–¥—ã (ASCII)
  let cmdHeader='';
  cmdHeader+='SIZE 40 mm,30 mm\r\n';
  cmdHeader+='GAP 2 mm,0 mm\r\n';
  cmdHeader+=`DIRECTION ${dir}\r\n`;
  cmdHeader+='REFERENCE 0,0\r\n';
  cmdHeader+='CODEPAGE 866\r\n';  // CP866 –¥–ª—è —Ä—É—Å—Å–∫–æ–≥–æ
  cmdHeader+='CLS\r\n';

  const headerBytes=[];
  for(let i=0;i<cmdHeader.length;i++){
    headerBytes.push(cmdHeader.charCodeAt(i));
  }

  // –¢–µ–∫—Å—Ç–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã
  const lines=[
    {text:l1,font:'4',yExtra:10},
    {text:l2,font:'3',yExtra:0},
    {text:l3,font:'3',yExtra:0},
    {text:l4,font:'3',yExtra:0},
    {text:l5,font:'3',yExtra:0}
  ];

  const bodyBytes=[];
  lines.forEach(line=>{
    if(!line.text) return;
    
    const prefix=`TEXT ${xLeft},${y},"${line.font}",0,1,1,"`;
    for(let i=0;i<prefix.length;i++){
      bodyBytes.push(prefix.charCodeAt(i));
    }
    
    // –¢–µ–∫—Å—Ç –≤ CP866
    const textBytes=toCP866(line.text);
    bodyBytes.push(...textBytes);
    
    bodyBytes.push(34); // "
    bodyBytes.push(13); // \r
    bodyBytes.push(10); // \n
    
    y+=yStep+line.yExtra;
  });

  const footer='PRINT 1,1\r\n';
  for(let i=0;i<footer.length;i++){
    bodyBytes.push(footer.charCodeAt(i));
  }

  return new Uint8Array([...headerBytes,...bodyBytes]);
}

// --- USB connect ---
async function connectUSB(){
  if(!navigator.usb){
    alert('‚ùå WebUSB —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤ Chrome/Edge');
    return;
  }
  try{
    usbDevice=await navigator.usb.requestDevice({
      filters:[
        {vendorId:0x0416},
        {vendorId:0x1FC9},
        {classCode:7}
      ]
    });
    await usbDevice.open();
    if(usbDevice.configuration===null){
      await usbDevice.selectConfiguration(1);
    }
    const iface=usbDevice.configuration.interfaces[0];
    await usbDevice.claimInterface(iface.interfaceNumber);
    const outEp=iface.alternate.endpoints.find(e=>e.direction==='out');
    if(outEp) usbEndpoint=outEp.endpointNumber;
    
    document.getElementById('usbStatus').textContent='üü¢ USB: –ø–æ–¥–∫–ª—é—á–µ–Ω '+(usbDevice.productName||'');
    document.getElementById('usbPrintBtn').disabled=false;
    document.getElementById('usbConnectBtn').disabled=true;
    document.getElementById('usbDisconnectBtn').disabled=false;
  }catch(e){
    console.error(e);
    alert('‚ùå –û—à–∏–±–∫–∞ USB: '+e.message);
  }
}

// --- USB disconnect ---
async function disconnectUSB(){
  if(!usbDevice) return;
  try{
    await usbDevice.close();
    usbDevice=null;
    
    document.getElementById('usbStatus').textContent='üî¥ USB: –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω';
    document.getElementById('usbPrintBtn').disabled=true;
    document.getElementById('usbConnectBtn').disabled=false;
    document.getElementById('usbDisconnectBtn').disabled=true;
  }catch(e){
    console.error(e);
    alert('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è: '+e.message);
  }
}

async function printUSB(){
  if(!usbDevice){
    alert('‚ùå –°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏ –ø—Ä–∏–Ω—Ç–µ—Ä');
    return;
  }
  const bytes=buildTSPL();
  console.log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –±–∞–π—Ç–æ–≤:',bytes.length);
  
  try{
    await usbDevice.transferOut(usbEndpoint,bytes);
    alert('‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ –ø—Ä–∏–Ω—Ç–µ—Ä!');
  }catch(e){
    console.error(e);
    alert('‚ùå –û—à–∏–±–∫–∞ –ø–µ—á–∞—Ç–∏: '+e.message);
  }
}

// --- PDF 40√ó30 landscape ---
async function exportPDF(){
  const {jsPDF}=window.jspdf;
  const pdf=new jsPDF({
    orientation:'landscape',
    unit:'mm',
    format:[40,30]
  });
  const canvas=await html2canvas(document.getElementById('preview'),{
    scale:2,
    backgroundColor:'#ffffff'
  });
  const img=canvas.toDataURL('image/png');
  pdf.addImage(img,'PNG',0,0,40,30);
  pdf.save('birka.pdf');
}

// --- PNG ---
async function exportPNG(){
  const canvas=await html2canvas(document.getElementById('preview'),{
    scale:2,
    backgroundColor:'#ffffff'
  });
  const a=document.createElement('a');
  a.href=canvas.toDataURL('image/png');
  a.download='birka.png';
  a.click();
}

// --- Browser print ---
function browserPrint(){
  const f1=12,f2=10,lh=1.2,pt=0.5;
  const label={
    line1:document.getElementById('l1').value,
    line2:document.getElementById('l2').value,
    line3:document.getElementById('l3').value,
    line4:document.getElementById('l4').value,
    line5:document.getElementById('l5').value
  };
  const html=`
    <div class="print-label" style="padding-top:${pt}mm;line-height:${lh}">
      <div style="font-size:${f1}pt;font-weight:bold">${label.line1||''}</div>
      <div style="font-size:${f2}pt">${label.line2||''}</div>
      <div style="font-size:${f2}pt">${label.line3||''}</div>
      <div style="font-size:${f2}pt">${label.line4||''}</div>
      <div style="font-size:${f2}pt">${label.line5||''}</div>
    </div>`;
  document.getElementById('printArea').innerHTML=html;
  setTimeout(()=>window.print(),200);
}

// events
document.getElementById('usbConnectBtn').addEventListener('click',connectUSB);
document.getElementById('usbDisconnectBtn').addEventListener('click',disconnectUSB);
document.getElementById('usbPrintBtn').addEventListener('click',printUSB);
document.getElementById('pdfBtn').addEventListener('click',exportPDF);
document.getElementById('pngBtn').addEventListener('click',exportPNG);
document.getElementById('printBtn').addEventListener('click',browserPrint);
</script>
</body>
</html>
